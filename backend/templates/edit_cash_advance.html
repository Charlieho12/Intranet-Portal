<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Cash Advance</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='kubota_icon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" type="text/css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
         .cash-advance-form {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #004d40;
        }

        .form-title {
            font-size: 24px;
            font-weight: bold;
            color: #004d40;
        }

        .form-section {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }

        .form-group {
            flex: 1;
        }

        .approver-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .approver-table th {
            background-color: #f5f5f5;
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }

        .approver-table td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        .meal-breakdown {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        .meal-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .meal-label {
            width: 120px;
            font-weight: bold;
        }

        .amount-input {
            width: 150px;
            padding: 6px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
            font-weight: bold;
        }

        .submit-btn {
            background-color: #004d40;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }

        .submit-btn:hover {
            background-color: #00796b;
        }
        .date-meal-selector {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
        }
        
        .date-selector {
            margin-bottom: 15px;
        }
        
        .meal-checkboxes {
            display: flex;
            gap: 15px;
        }
        
        .meal-checkbox-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .meal-dates-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        .meal-date-row {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .meal-date-row:last-child {
            border-bottom: none;
        }
        
        .date-header {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .meal-toggles {
            display: flex;
            gap: 15px;
        }
        
        input[type="checkbox"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }
        
        label {
            cursor: pointer;
        }
        input[readonly].amount-input {
            background-color: #f5f5f5;
            cursor: not-allowed;
            color: #555;
        }
        .misc-expenses-container {
        border: 1px solid #ddd;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 4px;
        }
        
        .expense-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .expense-item:last-child {
            border-bottom: none;
        }
        
        .expense-type {
            font-weight: bold;
            width: 150px;
        }
        
        .expense-amount-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .expense-delete {
            color: #e53935;
            cursor: pointer;
            margin-left: 10px;
            font-size: 18px;
        }
        
        .add-expense-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            margin-bottom: 15px;
        }
        
        .expense-type-dropdown {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            flex-grow: 1;
        }
        
        .btn-add-expense {
            background-color: #00897b;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
        }
        
        .btn-add-expense:hover {
            background-color: #00796b;
        }
        
        #misc-expenses-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* For "Other" expense type custom input */
        .custom-expense-input {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
            width: 150px;
        }
        .currency-indicator {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }
    
    .badge {
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
    }
    
    .badge-warning {
        background-color: #ffc107;
        color: #212529;
    }
    
    .badge-info {
        background-color: #17a2b8;
        color: white;
    }
    
    .currency-summary {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 4px;
        border: 1px solid #ddd;
    }
    
    .currency-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .currency-table td {
        padding: 8px;
        border-bottom: 1px solid #eee;
    }
    
    .currency-table tr:last-child td {
        border-bottom: none;
    }
    
    .exchange-rate-info {
        text-align: center;
        font-style: italic;
        color: #6c757d;
        padding-top: 10px;
    }
    
    .php-equivalent {
        color: #6c757d;
        font-size: 0.9em;
        margin-top: 5px;
        font-style: italic;
    }
    .total-row-highlight {
        background-color: #f0f8ff;
        font-size: 1.1em;
    }
    
    .total-row-highlight td {
        padding: 12px 8px;
        border-top: 2px solid #17a2b8;
        border-bottom: 2px solid #17a2b8;
    }
    
    #total-amount {
        font-size: 1.2em;
        font-weight: bold;
    }
    
    #total-amount div:nth-child(2) {
        margin-top: 5px;
    }
    @media print {
        body * {
            visibility: hidden !important;
        }
        #printable-report, #printable-report * {
            visibility: visible !important;
        }
        #printable-report {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            background: white;
            color: black;
            padding: 20px;
        }
    }
    .print-btn {
        background-color: #ff9800;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 20px;
        margin-left: 10px;
        transition: background 0.2s;
    }
    .print-btn:hover {
        background-color: #fb8c00;
    }
    .print-btn:active {
        background-color: #ef6c00;
    }
    @media print {
        .print-btn {
            display: none !important;
        }
    }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <strong class="head-text">Kubota Philippines Inc.</strong>
            <p class="subhead-text">232 Quirino High, Brgy. Baesa, Quezon City</p>
        </header>

        <div class="cash-advance-form">
            <div class="form-header">
                <div class="form-title">EDIT CASH ADVANCE</div>
            </div>

            <form id="edit-cash-advance-form">
                <!-- Basic Information -->
                <div class="form-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="employee-name">Name:</label>
                            <input type="text" id="employee-name" name="employeeName" value="{{ cash_advance.employeeName }}" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="toa-reference">TOA Reference:</label>
                            <input type="text" id="toa-reference" name="toaReference" value="{{ toa_number }}" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="toa-date">TOA Date:</label>
                            <input type="text" id="toa-date" name="toaDate" value="{{ travel.dateFiled.strftime('%Y-%m-%d') if travel.dateFiled else '' }}" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="travel-dates">Travel Period:</label>
                            <input type="text" id="travel-dates" name="travelDates" value="{{ travel.startDate.strftime('%Y-%m-%d') if travel.startDate else '' }} to {{ travel.endDate.strftime('%Y-%m-%d') if travel.endDate else '' }}" readonly>
                        </div>
                    </div>
                </div>

                <!-- Expenses Section -->
                <div class="form-section">
                    <h3>Expenses:</h3>
                    <!-- Meals -->
                    <div class="meal-breakdown">
                        <h4>Meals:</h4>
                        <div class="meal-dates-container" id="meal-dates-container">
                            {% set is_international = cash_advance.isInternational or travel.travelType == "2" %}
                            {% set breakfast_amount = 10 if is_international else 180 %}
                            {% set lunch_amount = 10 if is_international else 180 %}
                            {% set dinner_amount = 20 if is_international else 180 %}
                            {% set currency = 'USD' if is_international else 'PHP' %}
                            {% if travel.itinerary %}
                            {% for day in travel.itinerary %}
                                {% set safe_date = day.date|replace('/', '-') %}
                                <div class="meal-date-row" data-date="{{ day.date }}">
                                    <div class="date-header">{{ day.date }}</div>
                                    <div class="meal-toggles">
                                        <div class="meal-checkbox-group">
                                            <input type="checkbox" class="meal-checkbox" id="breakfast-{{ safe_date }}"
                                                {% if day.meals.breakfast %}checked{% endif %}>
                                            <label for="breakfast-{{ safe_date }}">Breakfast ({{ currency }} {{ breakfast_amount }})</label>
                                        </div>
                                        <div class="meal-checkbox-group">
                                            <input type="checkbox" class="meal-checkbox" id="lunch-{{ safe_date }}"
                                                {% if day.meals.lunch %}checked{% endif %}>
                                            <label for="lunch-{{ safe_date }}">Lunch ({{ currency }} {{ lunch_amount }})</label>
                                        </div>
                                        <div class="meal-checkbox-group">
                                            <input type="checkbox" class="meal-checkbox" id="dinner-{{ safe_date }}"
                                                {% if day.meals.dinner %}checked{% endif %}>
                                            <label for="dinner-{{ safe_date }}">Dinner ({{ currency }} {{ dinner_amount }})</label>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                            {% endif %}
                        </div>
                        <div class="total-row">
                            <span>Total Meals:</span>
                            <span id="total-meals">PHP 0.00</span>
                            <input type="hidden" id="total-meals-value" name="totalMeals" value="0">
                        </div>
                    </div>

                    {% if cash_advance.hotel %}
                    <div id="hotel-section" class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="hotel-expense">Hotel Amount:</label>
                            <input type="number" id="hotel-expense" name="hotelExpense" class="amount-input expense-amount" min="0" step="0.01" value="{{ cash_advance.hotel }}">
                            <span>PHP</span>
                        </div>
                    </div>
                    {% endif %}

                    {% if cash_advance.transportation %}
                    <div id="transportation-section" class="form-row">
                        <div class="form-group">
                            <label for="transportation">Transportation:</label>
                            <input type="number" id="transportation" name="transportation" class="amount-input expense-amount" min="0" step="0.01" value="{{ cash_advance.transportation }}">
                            <span>PHP</span>
                        </div>
                    </div>
                    {% endif %}

                    {% if cash_advance.tnvsPaymentType == "Cash" %}
                    <div id="tnvs-section" class="form-row">
                        <div class="form-group">
                            <label for="tnvs-amount">TNVS Amount (Cash):</label>
                            <input type="number" id="tnvs-amount" name="tnvsAmount" class="amount-input expense-amount" min="0" step="0.01" value="{{ cash_advance.tnvsAmount or 0 }}">
                            <span>PHP</span>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Miscellaneous Expenses (dynamic) -->
                    <div class="misc-expenses-container">
                        <h4>Miscellaneous Expenses:</h4>
                        <div id="misc-expenses-list">
                            {% if cash_advance.miscellaneous %}
                                {% for key, item in cash_advance.miscellaneous.items() %}
                                    <div class="expense-item" data-type="{{ key }}">
                                        <span class="expense-type">{{ item.label }}</span>
                                        <div class="expense-amount-container">
                                            <input type="number" class="amount-input misc-expense-amount" min="0" step="0.01" value="{{ item.amount }}">
                                            <span>PHP</span>
                                            <span class="expense-delete">&times;</span>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="add-expense-row">
                            <select id="expense-type-selector" class="expense-type-dropdown">
                                <option value="">-- Select expense type --</option>
                                <option value="tollFee">Toll Fee</option>
                                <option value="parking">Parking</option>
                                <option value="carRental">Car Rental</option>
                                <option value="carwash">Car Wash</option>
                                <option value="laundry">Laundry</option>
                                <option value="other">Other</option>
                            </select>
                            <button type="button" id="add-expense-btn" class="btn-add-expense">Add Expense</button>
                        </div>
                        <div class="total-row" style="margin-top: 15px;">
                            <span>Total Miscellaneous:</span>
                            <span id="total-misc">PHP 0.00</span>
                        </div>
                    </div>
                </div>

                <!-- International Logic -->
                {% if cash_advance.isInternational or travel.travelType == "2" %}
                <div class="currency-indicator">
                    <span class="badge badge-warning">International Travel</span>
                </div>
                <div id="daily-allowance-section" class="form-row">
                    <div class="form-group">
                        <label>Daily Allowance (USD {{ cash_advance.dailyAllowance.usd if cash_advance.dailyAllowance else 0 }}):</label>
                        <input type="number" id="daily-allowance" class="amount-input expense-amount"
                            value="{{ cash_advance.dailyAllowance.usd if cash_advance.dailyAllowance else 0 }}" readonly>
                        <span>USD</span>
                    </div>
                </div>
                {% endif %}

                <!-- Total Amount -->
                <div class="form-section">
                    <div class="total-row">
                        <span>TOTAL AMOUNT:</span>
                        <span id="total-amount">PHP {{ cash_advance.totalAmount or 0 }}</span>
                    </div>
                </div>

                <!-- Details Section -->
                <div class="form-section">
                    <h3>Details:</h3>
                    <textarea name="details" rows="4" style="width: 97%">{{ cash_advance.details }}</textarea>
                </div>

                <div class="button-container">
                    <button type="submit" class="submit-btn">Save Changes</button>
                    <a href="/cash-advance-approval/{{ toa_number }}" class="btn-cancel">Cancel</a>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Add Miscellaneous Expense Row
        $('#add-expense-btn').on('click', function() {
            const expenseType = $('#expense-type-selector').val();
            if (!expenseType) {
                alert('Please select an expense type');
                return;
            }
            let expenseLabel = $('#expense-type-selector option:selected').text();
            if (expenseType === 'other') {
                const customLabel = prompt('Please enter the expense description:');
                if (!customLabel) return;
                expenseLabel = customLabel;
            }
            const expenseId = 'expense-' + Date.now();
            const expenseItem = $(`
                <div class="expense-item" id="${expenseId}" data-type="${expenseType}">
                    <span class="expense-type">${expenseLabel}</span>
                    <div class="expense-amount-container">
                        <input type="number" class="amount-input misc-expense-amount" min="0" step="0.01" value="0">
                        <span>PHP</span>
                        <span class="expense-delete">&times;</span>
                    </div>
                </div>
            `);
            $('#misc-expenses-list').append(expenseItem);
            $('#expense-type-selector').val('');
            expenseItem.find('.expense-delete').on('click', function() {
                expenseItem.remove();
                calculateTotals();
            });
            expenseItem.find('.misc-expense-amount').on('input', function() {
                calculateTotals();
            });
            calculateTotals();
        });

        $(document).on('click', '.expense-delete', function() {
            $(this).closest('.expense-item').remove();
            calculateTotals();
        });

        function calculateTotals() {
            const isInternational = {{ 'true' if cash_advance.isInternational or travel.travelType == "2" else 'false' }};
            const exchangeRate = {{ cash_advance.exchangeRate or 55 }};
            const breakfastAmount = isInternational ? 10 : 180;
            const lunchAmount = isInternational ? 10 : 180;
            const dinnerAmount = isInternational ? 20 : 180;

            let mealsUsdTotal = 0;
            let mealsPhpTotal = 0;

            $('#meal-dates-container .meal-date-row').each(function() {
                const date = $(this).data('date');
                const safeDate = date.replace(/\//g, '-');
                if ($(this).find('#breakfast-' + safeDate).is(':checked')) {
                    if (isInternational) {
                        mealsUsdTotal += breakfastAmount;
                    } else {
                        mealsPhpTotal += breakfastAmount;
                    }
                }
                if ($(this).find('#lunch-' + safeDate).is(':checked')) {
                    if (isInternational) {
                        mealsUsdTotal += lunchAmount;
                    } else {
                        mealsPhpTotal += lunchAmount;
                    }
                }
                if ($(this).find('#dinner-' + safeDate).is(':checked')) {
                    if (isInternational) {
                        mealsUsdTotal += dinnerAmount;
                    } else {
                        mealsPhpTotal += dinnerAmount;
                    }
                }
            });

            // Show only USD for international, PHP for domestic
            if (isInternational) {
                $('#total-meals').html(
                    `<div>USD ${mealsUsdTotal.toFixed(2)}</div>`
                );
            } else {
                $('#total-meals').text('PHP ' + mealsPhpTotal.toFixed(2));
            }
            $('#total-meals-value').val(isInternational ? mealsUsdTotal : mealsPhpTotal);

            // Miscellaneous
            let miscTotal = 0;
            $('#misc-expenses-list .misc-expense-amount').each(function() {
                miscTotal += parseFloat($(this).val()) || 0;
            });
            $('#total-misc').text('PHP ' + miscTotal.toFixed(2));

            // Hotel & Transportation
            let hotel = $('#hotel-expense').length ? parseFloat($('#hotel-expense').val()) || 0 : 0;
            let transportation = $('#transportation').length ? parseFloat($('#transportation').val()) || 0 : 0;
            let tnvsAmount = $('#tnvs-amount').length ? parseFloat($('#tnvs-amount').val()) || 0 : 0;

            // Total
            if (isInternational) {
                // Only sum USD values for total USD, PHP values for total PHP
                let totalUsd = mealsUsdTotal;
                let totalPhp = miscTotal + hotel + transportation + tnvsAmount;
                $('#total-amount').html(
                    `<div>USD ${totalUsd.toFixed(2)}</div>
                    <div>PHP ${totalPhp.toFixed(2)}</div>`
                );
            } else {
                let total = mealsPhpTotal + miscTotal + hotel + transportation + tnvsAmount;
                $('#total-amount').text('PHP ' + total.toFixed(2));
            }
        }
        // Bind meal-checkbox and expense-amount events only once on page load
        $(document).ready(function() {
            calculateTotals();
            $(document).on('change input', '.meal-checkbox, .expense-amount, .misc-expense-amount', function() {
                calculateTotals();
            });
        });

        $('#edit-cash-advance-form').on('submit', function(e) {
            e.preventDefault();
            let formData = {
                employeeName: $('#employee-name').val(),
                toaReference: $('#toa-reference').val(),
                toaDate: $('#toa-date').val(),
                meals: { detailed: {} },
                hotel: $('#hotel-expense').length ? parseFloat($('#hotel-expense').val()) || 0 : 0,
                transportation: $('#transportation').length ? parseFloat($('#transportation').val()) || 0 : 0,
                tnvsAmount: $('#tnvs-amount').length ? parseFloat($('#tnvs-amount').val()) || 0 : 0,
                tnvsPaymentType: "{{ cash_advance.tnvsPaymentType or '' }}",
                miscellaneous: {},
                details: $('textarea[name="details"]').val(),
                isInternational: {{ 'true' if cash_advance.isInternational or travel.travelType == "2" else 'false' }} === 'true',
                dailyAllowance: {{ cash_advance.dailyAllowance.usd if cash_advance.dailyAllowance else 0 }}
            };

            // Meals
            $('#meal-dates-container .meal-date-row').each(function() {
                const date = $(this).data('date');
                const safeDate = date.replace(/\//g, '-');
                formData.meals.detailed[date] = {
                    breakfast: $(this).find('#breakfast-' + safeDate).is(':checked') ? (formData.isInternational ? 10 : 180) : 0,
                    lunch: $(this).find('#lunch-' + safeDate).is(':checked') ? (formData.isInternational ? 10 : 180) : 0,
                    dinner: $(this).find('#dinner-' + safeDate).is(':checked') ? (formData.isInternational ? 20 : 180) : 0
                };
            });

            // Miscellaneous
            $('#misc-expenses-list .expense-item').each(function(index) {
                const label = $(this).find('.expense-type').text();
                const amount = parseFloat($(this).find('.misc-expense-amount').val()) || 0;
                if (label && amount > 0) {
                    formData.miscellaneous['item' + (index + 1)] = { label, amount };
                }
            });

            $.ajax({
                url: '/api/cash-advance/{{ toa_number }}/update',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    alert('Cash advance updated successfully!');
                    window.location.href = '/home';
                },
                error: function(error) {
                    alert('Error updating cash advance.');
                }
            });
        });
    </script>