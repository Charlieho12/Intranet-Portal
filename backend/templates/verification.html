<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" type="text/css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <title>Travel Authority Verification</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='kubota_icon.png') }}">
    <style>
        .flight-time-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        
        .flight-time-group label {
            min-width: 100px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            margin-left: 10px;
            font-weight: bold;
        }
        
        .form-input {
            margin-left: 10px;
            margin-right: 10px;
            width: 650px;
            padding: 8px;
            border: 1px solid #aaa;
            border-radius: 4px;
        }
        
        textarea.form-input {
            min-height: 80px;
        }
        
        .section-title {
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        
        .button-container {
            display: flex;
            justify-content: flex-end;
            padding: 15px 0;
            gap: 10px;
        }
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .half-width {
            flex: 1;
        }
        
        input[readonly] {
            background-color: #f5f5f5;
            cursor: default;
        }
        .destinations-list {
            background-color: #f5f5f5;
            padding: 8px;
            border: 1px solid #aaa;
            border-radius: 4px;
            min-height: 24px;
            max-height: 30px; /* Match the height of regular inputs */
            width: 100%;
            box-sizing: border-box;
            font-size: 0.6rem;
     
        }
        #hotel-location {
            background-color: #f5f5f5;
            cursor: default;
            border: 1px solid #ddd;
        }
        #add-hotel-btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(79,70,229,0.15);
            transition: background 0.2s, transform 0.2s;
            margin-bottom: 5px;
            margin-top: 5px;
            display: inline-block;
        }
        #add-hotel-btn:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%);
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 8px 24px rgba(79,70,229,0.25);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <strong class="head-text">Kubota Philippines Inc.</strong>
            <p class="subhead-text">232 Quirino High, Brgy. Baesa, Quezon City</p>
        </header>
        
        <form id="verification-form" class="form-container">
            <div class="form">
                <header>
                    <strong class="head-text">Travel Order Authority Verification</strong>
                </header>
                <!-- TOA Basic Information -->
                <div class="form-section">
                    
                    <div class="fields travel-details">
                        <div class="field-right">
                            <div class="input-field">
                                <label class="subhead-text bold">TOA Number</label>
                                <input type="text" id="toa-number" class="subhead-text" value="{{ toa_number }}" readonly>
                            </div>
                            <div class="input-field">
                                <label class="subhead-text bold">Date Filed</label>
                                <input id="dateFiled" class="subhead-text" type="datetime-local" readonly>
                            </div>
                            <div class="input-field">
                                <label class="subhead-text bold">Employee ID</label>
                                <input id="employeeId" class="subhead-text" type="text" readonly>
                            </div>
                            <div class="input-field">
                                <label class="subhead-text bold">Employee Name</label>
                                <input id="employeeName" class="subhead-text" type="text" readonly>
                            </div>
                        </div>
    
                        <div class="field-left">
                            <div class="input-field">
                                <label class="subhead-text bold">Travel Type</label>
                                <input id="travelType" class="subhead-text" type="text" readonly>
                            </div>
                            <div class="double-input-field">
                                <div class="input-field">
                                    <label class="subhead-text bold">Start from</label>
                                    <input id="startDate" class="subhead-text" type="date" readonly>
                                </div>
                                <div class="input-field">
                                    <label class="subhead-text bold">End Date</label>
                                    <input id="endDate" class="subhead-text" type="date" readonly>
                                </div>
                            </div>
    
                            <div class="input-field" id="origin-container">
                                <label class="subhead-text bold">Origin</label>
                                <input id="origin" class="subhead-text" type="text" readonly>
                            </div>
                            
                            <div class="input-field" id="destination-container">
                                <label class="subhead-text bold">Destination(s)</label>
                                <div id="destinations-list" class="destinations-list"></div>
                            </div>
                        </div>
                    </div>

                <!-- Flight Schedule Section -->
                <div id="flight-time-container" style="display: none;">
                    <label class="section-title">Flight Schedule</label>
                    
                    <div id="flight-time-edit" style="display: none;">
                        <div class="flight-time-group">
                            <label class="subhead-text bold">Departure:</label>
                            <input type="datetime-local" id="departure-time" class="subhead-text">
                        </div>
                        <div class="flight-time-group">
                            <label class="subhead-text bold">Return:</label>
                            <input type="datetime-local" id="arrival-time" class="subhead-text">
                        </div>
                    </div>
                    
                    <!-- Readonly version (for everyone else) -->
                    <div id="flight-time-display">
                        <div class="flight-time-group">
                            <label class="subhead-text bold">Departure:</label>
                            <span id="departure-display" class="subhead-text">Not specified</span>
                        </div>
                        <div class="flight-time-group">
                            <label class="subhead-text bold">Return:</label>
                            <span id="arrival-display" class="subhead-text">Not specified</span>
                        </div>
                    </div>
                </div>

                <!-- Hotel Details Section -->
                <div class="form-section">
                    <label class="section-title" style="margin-left: 10px">Hotel Details</label>
                    <div class="form-group">
                        <label for="hotel-start-date" class="form-label">Hotel Start Date</label>
                        <input type="date" id="hotel-start-date" name="hotelStartDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="hotel-end-date" class="form-label">Hotel End Date</label>
                        <input type="date" id="hotel-end-date" name="hotelEndDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="hotel-location" class="form-label">Hotel Location</label>
                        <input type="text" id="hotel-location" name="hotelLocation" class="form-input" readonly>
                    </div>
                    <div class="form-group">
                        <label for="hotel-name" class="form-label">Hotel Name</label>
                        <select id="hotel-name" name="hotelName" class="form-input" style="background-color: white;width: 668px;height: 39px;">
                            <option value="">Select Hotel</option>
                            <!-- Hotels will be populated dynamically -->
                        </select>
                    </div>

                    <div class="form-group" id="other-hotel-container" style="display: none;">
                        <label for="other-hotel-name" class="form-label">Specify Hotel Name</label>
                        <input type="text" id="other-hotel-name" name="otherHotelName" class="form-input" placeholder="Enter hotel name">
                    </div>
                    
                    <div class="form-group">
                        <label for="hotel-amount" class="form-label">Hotel Amount</label>
                        <input type="number" id="hotel-amount" name="hotelAmount" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label for="payment-type" class="form-label">Payment Type</label>
                        <select id="payment-type" name="paymentType" class="form-input" style="background-color: white;width: 668px;height: 39px;">
                            <option value="">Select Payment Type</option>
                            <option value="Send Bill">Send Bill</option>
                            <option value="Credit Card">Credit Card</option>
                            <option value="Cash">Cash</option>
                        </select>
                    </div>
                    <div id="hotels-list"></div>
                    <button type="button" id="add-hotel-btn" style="margin:10px 0 20px 10px;">Add Another Hotel</button>

                </div>

                <!-- Remarks Section -->
                <div class="form-section">
                    <label class="section-title" style="margin-left: 10px">Remarks</label>
                    <div class="form-group">
                        <textarea id="remarks" name="remarks" class="form-input" placeholder="Enter any remarks here..."></textarea>
                    </div>
                </div>
                
                <div class="button-container">
                    <a href="/logout" class="btn-submit logout-button">Logout</a>
                    <button type="submit" class="btn-submit">Submit Verification</button>
                </div>
            </div>
        </form>
    </div>

    <script>
        $(document).ready(function() {
            // Check if all hotel data is properly initialized
            console.log("Hotel data loaded:", hotelData.length, "hotels");
            console.log("Hotels by location:", Object.keys(hotelsByLocation).length, "locations");
            
            // Load travel and verification data with a slight delay to ensure DOM is ready
            let destinationLocation = "";
    
            // First load travel details
            loadTravelDetails().then(location => {
                destinationLocation = location;
                console.log("Destination location from promise:", destinationLocation);
                
                // Then load verification details with the destination location
                return loadVerificationDetails(destinationLocation);
            }).then(() => {
                // Setup form based on user role
                const employeeId = "{{ current_user.employeeId }}";
                const coordinatorId = "{{ coordinator.employeeId }}";
                console.log("Current user employee ID:", employeeId);
                console.log("Coordinator employee ID:", coordinatorId);
                
                const isCoordinator = employeeId === coordinatorId;
                console.log("Is Coordinator:", isCoordinator);
                
                setupFormForUser(isCoordinator);
            });
            
            // Form submission handler
            $('#verification-form').on('submit', function(e) {
                e.preventDefault();
                submitVerification();
            });

            function toggleHotelAmount() {
                if ($('#payment-type').val() === 'Cash') {
                    $('#hotel-amount').closest('.form-group').show();
                } else {
                    $('#hotel-amount').closest('.form-group').hide();
                    $('#hotel-amount').val('');
                }
            }

            // Run on page load
            toggleHotelAmount();

            // Run when payment type changes
            $('#payment-type').on('change', toggleHotelAmount);

        });
        
        function setupFormForUser(isCoordinator) {
            console.log("Setting up form for Coordinator:", isCoordinator); // Add debugging

            if (isCoordinator) {
                // Show editable flight times
                $('#flight-time-edit').show();
                $('#flight-time-display').hide();

                // Enable input fields (text/number) with readonly attribute

                // Enable hotel date fields
                $('#hotel-start-date, #hotel-end-date').prop('readonly', false).prop('disabled', false).css('background-color', 'white');

                // Enable select elements with disabled attribute
                $('#hotel-name, #payment-type')
                    .prop('disabled', false)
                    .css('background-color', 'white');

                // Show the submit button
                $('.btn-submit').show();
            } else {
                // Show readonly flight times
                $('#flight-time-edit').hide();
                $('#flight-time-display').show();

                // Disable input fields
                $('#hotel-amount, #remarks, #departure-time, #arrival-time')
                    .prop('readonly', true)
                    .css('background-color', '#f5f5f5');

                // Disable hotel date fields
                $('#hotel-start-date, #hotel-end-date').prop('readonly', true).prop('disabled', true).css('background-color', '#f5f5f5');

                // Disable select elements
                $('#hotel-name, #payment-type')
                    .prop('disabled', true)
                    .css('background-color', '#f5f5f5');

                // Hide the submit button
                $('.btn-submit').hide();
            }
        }
        function loadTravelDetails() {
            return new Promise((resolve, reject) => {
                $.get(`/api/travel/{{ toa_number }}`, function(data) {
                    console.log("Travel data loaded:", data); // Debug info
                    
                    
                    // Populate employee information
                    $('#employeeName').val(data.employee || 'Not specified');
                    $('#employeeId').val(data.employeeId || 'Not specified');
                    
                    // Populate department and position if available
                $('#department').val(data.department || 'Not specified');
                $('#position').val(data.position || 'Not specified');
                
                

                    $('#dateFiled').val(data.dateFiled);
                    
                    // Map travel type codes to readable names
                    const travelTypes = {
                        "3": "Domestic",
                        "2": "International"
                    };
                    $('#travelType').val(travelTypes[data.travelType] || 'Not specified');
                    
                    // Populate travel dates
                    $('#startDate').val(formatDateOnlyForInput(data.startDate));
                    $('#endDate').val(formatDateOnlyForInput(data.endDate));
                    
                    // Populate origin
                    $('#origin').val(data.origin || 'Not specified');
                    
                    // Handle destinations and update hotel options
                    let selectedDestination = "";
                    
                    // Get destination from data
                    if (data.destinations && Array.isArray(data.destinations) && data.destinations.length > 0) {
                        const destinationsContainer = $('#destinations-list');
                        destinationsContainer.empty();
                        
                        // Use the first destination to set the hotel location
                        selectedDestination = data.destinations[0];
                        console.log("Selected first destination from array:", selectedDestination);
                        
                        data.destinations.forEach(function(destination) {
                            destinationsContainer.append(
                                `<div class="destination-item">${destination}</div>`
                            );
                        });
                    } else if (data.destinations && typeof data.destinations === 'string') {
                        $('#destinations-list').html(
                            `<div class="destination-item">${data.destinations}</div>`
                        );
                        selectedDestination = data.destinations;
                        console.log("Selected destination from string:", selectedDestination);
                    } else {
                        $('#destinations-list').html(
                            `<div class="destination-item">Not specified</div>`
                        );
                        console.log("No destination found in data");
                    }
                    
                    // Find the matching location for the destination
                    const matchedLocation = findMatchingLocation(selectedDestination);
                    console.log("Matched location:", matchedLocation);
                    
                    // Set the final location value (matched location or original destination)
                    const finalLocation = matchedLocation || selectedDestination || "";
                    
                    // Update hotel options based on the location
                    updateHotelOptions(finalLocation);
                    
                    // Resolve the promise with the final location
                    resolve(finalLocation);
                    
                }).fail(function(error) {
                    console.error('Error loading travel details:', error);
                    reject(error);
                });
            });
        }

        // Function to find the best matching location for a destination
        function findMatchingLocation(destination) {
            if (!destination) return null;
            
            // Clean and standardize the destination string
            const cleanDest = destination.toLowerCase().trim();
            console.log("Finding match for destination:", cleanDest); // Debug output
            
            // First try: direct match
            for (const location in hotelsByLocation) {
                if (location.toLowerCase() === cleanDest) {
                    console.log("Direct match found:", location); // Debug output
                    return location;
                }
            }
            
            // Second try: partial match (location contains destination or vice versa)
            for (const location in hotelsByLocation) {
                if (location.toLowerCase().includes(cleanDest) || cleanDest.includes(location.toLowerCase())) {
                    console.log("Partial match found:", location); // Debug output
                    return location;
                }
            }
            
            // Get the first word of destination (often the city name)
            const firstWord = cleanDest.split(',')[0].trim();
            if (firstWord !== cleanDest) {
                // Try matching with just the first word
                for (const location in hotelsByLocation) {
                    if (location.toLowerCase().includes(firstWord) || firstWord.includes(location.toLowerCase())) {
                        console.log("First word match found:", location); // Debug output
                        return location;
                    }
                }
            }
            
            console.log("No match found for destination:", cleanDest); // Debug output
            return null; // No match found
        }

        // Function to update hotel dropdown based on destination
        function updateHotelOptions(destination) {
            console.log("Updating hotel options for destination:", destination);
            
            const hotelDropdown = $('#hotel-name');
            hotelDropdown.empty();
            hotelDropdown.append('<option value="">Select Hotel</option>');
            
            // Add "Other" option
            hotelDropdown.append('<option value="Other">Other</option>');
            
            // Try to find matching location and hotels
            const matchedLocation = findMatchingLocation(destination);
            console.log("Matched location:", matchedLocation);
            
            // ALWAYS SET the hotel location to the destination value
            if (destination) {
                $('#hotel-location').val(matchedLocation || destination);
                console.log("Set hotel-location to:", $('#hotel-location').val());
            }
            
            if (matchedLocation && hotelsByLocation[matchedLocation]) {
                // Add hotels for this location, sorted alphabetically
                const hotels = [...hotelsByLocation[matchedLocation]].sort();
                hotels.forEach(hotel => {
                    hotelDropdown.append(`<option value="${hotel}">${hotel}</option>`);
                });
                console.log("Added", hotels.length, "hotels to dropdown");
            } else if (destination) {
                console.log("No hotels found for location:", destination);
            }
        }
        
        // Add this helper function for formatting dates
        function formatDateOnlyForInput(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const pad = num => num.toString().padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}`;
        }
        function loadVerificationDetails(destinationLocation) {
            return new Promise((resolve, reject) => {
                $.get(`/api/verification/{{ toa_number }}`, function(data) {
                    // Preserve the destination location no matter what
                    const preservedLocation = destinationLocation;
                    console.log("Preserved location:", preservedLocation);
                    
                    // Populate flight times if they exist
                    if (data.flightDetails) {
                        $('#departure-time').val(formatDateTimeForInput(data.flightDetails.departure));
                        $('#arrival-time').val(formatDateTimeForInput(data.flightDetails.arrival));
                        $('#departure-display').text(formatDisplayDateTime(data.flightDetails.departure));
                        $('#arrival-display').text(formatDisplayDateTime(data.flightDetails.arrival));
                    }

                    // Show flight time container for international/domestic travel
                    const travelType = data.travelType || "2";
                    if (travelType === "2" || travelType === "3") {
                        $('#flight-time-container').show();
                    } else {
                        $('#flight-time-container').hide();
                    }

                    // Populate hotel details
                    if (data.hotel) {
                        const hotelName = data.hotel.name || '';
                        
                        // Check if the hotel name is in our predefined list
                        let foundInList = false;
                        $('#hotel-name option').each(function() {
                            if ($(this).val() === hotelName) {
                                foundInList = true;
                                return false; // Break the loop
                            }
                        });
                        
                        if (foundInList) {
                            $('#hotel-name').val(hotelName);
                            $('#other-hotel-container').hide();
                        } else if (hotelName) {
                            // If not in the list but we have a name, select "Other" and fill in custom name
                            $('#hotel-name').val('Other');
                            $('#other-hotel-name').val(hotelName);
                            $('#other-hotel-container').show();
                        }
                        
                        // ALWAYS use the destination location, regardless of what's in verification data
                        $('#hotel-amount').val(data.hotel.amount || '');
                        $('#payment-type').val(data.hotel.paymentType || '');
                    }
                    
                    // After everything is populated, force the hotel location to match the destination
                    $('#hotel-location').val(preservedLocation);
                    console.log("Final hotel location set to:", $('#hotel-location').val());

                    // Populate remarks
                    $('#remarks').val(data.remarks || '');
                    
                    resolve();
                }).fail(function(error) {
                    console.error('Error loading verification details:', error);
                    alert('Failed to load verification details. Please try again.');
                    reject(error);
                });
            });
        }
        
        function submitVerification() {
            // Get employee email from the loaded travel details
            const employeeName = $('#employeeName').val();
            
            // Get the hotel name (handle "Other" option)
            let hotelName = $('#hotel-name').val();
            if (hotelName === 'Other') {
                hotelName = $('#other-hotel-name').val() || 'Other';
            }
            
            const formData = {
                flightDetails: {
                    departure: $('#departure-time').val(),
                    arrival: $('#arrival-time').val()
                },
                hotel: {
                    name: hotelName,
                    location: $('#hotel-location').val(),
                    amount: $('#hotel-amount').val(),
                    paymentType: $('#payment-type').val(),
                    startDate: $('#hotel-start-date').val(),  
                    endDate: $('#hotel-end-date').val()
                },
                verificationStatus: 'Verified',
                remarks: $('#remarks').val(),
                employeeName: employeeName, // Include employee name for email
                toaNumber: "{{ toa_number }}" // Include TOA number
            };
            
            $.ajax({
                url: `/api/verification/{{ toa_number }}`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    alert('Verification details saved successfully! Email notification has been sent to the employee.');
                    // Optionally redirect or update UI
                },
                error: function(error) {
                    console.error('Error saving verification:', error);
                    alert('Failed to save verification details. Please try again.');
                }
            });
        }
        
        function formatDisplayDateTime(dateTime) {
            if (!dateTime) return 'Not specified';
            const date = new Date(dateTime);
            return date.toLocaleString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true
            });
        }
        
        function formatDateTimeForInput(dateTime) {
            if (!dateTime) return '';
            const date = new Date(dateTime);
            const pad = num => num.toString().padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
        }

        $('#hotel-name').change(function() {
            if ($(this).val() === 'Other') {
                $('#other-hotel-container').show();
            } else {
                $('#other-hotel-container').hide();
            }
        });

        // Hotel date range validation
        $('#hotel-start-date, #hotel-end-date').on('change', function() {
            const hotelStart = $('#hotel-start-date').val();
            const hotelEnd = $('#hotel-end-date').val();
            const startDate = $('#startDate').val();
            const endDate = $('#endDate').val();

            if (!hotelStart || !hotelEnd || !startDate || !endDate) return;

            // Check if hotel dates are within TOA dates
            if (hotelStart !== startDate || hotelEnd !== endDate) {
                alert('Hotel Start and End Dates must exactly match the TOA Start and End Dates.');
                $('#hotel-start-date').val('');
                $('#hotel-end-date').val('');
            }
        });

        const hotelData = [
            { name: "The Hotel Andrea", location: "Cauayan City, Isabela" },
            { name: "The Mango Suites Tuguegarao", location: "Tuguegarao" },
            { name: "The Mango Suites Cauayan", location: "Cauayan City, Isabela" },
            { name: "La Maja Rica", location: "Tarlac" },
            { name: "My Northstar Hotel", location: "Tarlac" },
            { name: "Topstar Hotel", location: "Nueva Ecija" },
            { name: "Harvest Hotel", location: "Nueva Ecija" },
            { name: "Huanying Hotel", location: "Calapan Mindoro" },
            { name: "Figtree Hotel", location: "Ilo-Ilo" },
            { name: "Java Hotel", location: "Ilocos Norte" },
            { name: "Hotel Lapira", location: "Ilocos Sur, Vigan" },
            { name: "Pulsar Hotel", location: "Alimanao, Tuguegarao" },
            { name: "L' Square", location: "Tarlac" },
            { name: "Go Hotels Tacloban", location: "Tacloban" },
            { name: "Summit", location: "Tacloban" },
            { name: "Go Hotels Palawan", location: "Palawan" },
            { name: "Hotel Francesko", location: "San Jose, Nueva Ecija" },
            { name: "Bravo Tanauan Hotel", location: "Tanauan City, Batangas" },
            { name: "D' Elmers Place Hotel", location: "Tuguegarao" },
            { name: "Red Planet Timog", location: "Timog Ave, QC" },
            { name: "Blue Lotus Hotel", location: "Davao" },
            { name: "Luxebridge Suites (Sans Hotel)", location: "Davao" },
            { name: "Sunny Point Hotel", location: "Davao" },
            { name: "Red Planet Hotel", location: "Davao" }
        ];

        // Group hotels by location for easier lookup
        const hotelsByLocation = {};
        hotelData.forEach(hotel => {
            if (!hotelsByLocation[hotel.location]) {
                hotelsByLocation[hotel.location] = [];
            }
            hotelsByLocation[hotel.location].push(hotel.name);
        });

        // Additional safeguard to maintain the hotel location
        $(document).on('focus click', function() {
            const currentLocation = $('#hotel-location').val();
            const destinationText = $('#destinations-list').text().trim();
            
            // If the location is empty but we have a destination, restore it
            if (!currentLocation && destinationText && destinationText !== 'Not specified') {
                const matchedLocation = findMatchingLocation(destinationText);
                $('#hotel-location').val(matchedLocation || destinationText);
                console.log("Restored hotel location to:", $('#hotel-location').val());
            }
        });

        let hotelIndex = 0;

        function createHotelFields(hotel = {}) {
            hotelIndex++;
            return `
            <div class="hotel-entry" style="border:1px solid #ddd; border-radius:8px; padding:15px; margin-bottom:15px;">
                <div class="form-group">
                    <label class="form-label">Hotel Start Date</label>
                    <input type="date" name="hotelStartDate${hotelIndex}" class="form-input hotel-start-date" value="${hotel.startDate || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Hotel End Date</label>
                    <input type="date" name="hotelEndDate${hotelIndex}" class="form-input hotel-end-date" value="${hotel.endDate || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Hotel Location</label>
                    <input type="text" name="hotelLocation${hotelIndex}" class="form-input hotel-location" value="${hotel.location || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Hotel Name</label>
                    <input type="text" name="hotelName${hotelIndex}" class="form-input hotel-name" value="${hotel.name || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Hotel Amount</label>
                    <input type="number" name="hotelAmount${hotelIndex}" class="form-input hotel-amount" value="${hotel.amount || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Payment Type</label>
                    <select name="hotelPaymentType${hotelIndex}" class="form-input hotel-payment-type">
                        <option value="">Select Payment Type</option>
                        <option value="Send Bill" ${hotel.paymentType === 'Send Bill' ? 'selected' : ''}>Send Bill</option>
                        <option value="Credit Card" ${hotel.paymentType === 'Credit Card' ? 'selected' : ''}>Credit Card</option>
                        <option value="Cash" ${hotel.paymentType === 'Cash' ? 'selected' : ''}>Cash</option>
                    </select>
                </div>
                <button type="button" class="remove-hotel-btn" style="background:#ef4444;color:white;border:none;padding:6px 12px;border-radius:6px;margin-top:8px;">Remove</button>
            </div>
            `;
        }

        function getHotelsFromForm() {
            const hotels = [];
            $('#hotels-list .hotel-entry').each(function() {
                hotels.push({
                    startDate: $(this).find('.hotel-start-date').val(),
                    endDate: $(this).find('.hotel-end-date').val(),
                    location: $(this).find('.hotel-location').val(),
                    name: $(this).find('.hotel-name').val(),
                    amount: $(this).find('.hotel-amount').val(),
                    paymentType: $(this).find('.hotel-payment-type').val()
                });
            });
            return hotels;
        }

        $(document).ready(function() {
            // Add initial hotel fields (from backend if available)
            let initialHotels = [];
            $.get(`/api/verification/{{ toa_number }}`, function(data) {
                if (Array.isArray(data.hotels)) {
                    initialHotels = data.hotels;
                } else if (data.hotel) {
                    initialHotels = [data.hotel];
                }
                initialHotels.forEach(hotel => {
                    $('#hotels-list').append(createHotelFields(hotel));
                });
            });

            $('#add-hotel-btn').on('click', function() {
                $('#hotels-list').append(createHotelFields({}));
            });

            $('#hotels-list').on('click', '.remove-hotel-btn', function() {
                $(this).closest('.hotel-entry').remove();
            });

            // Override submitVerification to collect all hotels
            window.submitVerification = function() {
                const employeeName = $('#employeeName').val();
                const hotels = getHotelsFromForm();

                const formData = {
                    flightDetails: {
                        departure: $('#departure-time').val(),
                        arrival: $('#arrival-time').val()
                    },
                    hotels: hotels,
                    verificationStatus: 'Verified',
                    remarks: $('#remarks').val(),
                    employeeName: employeeName,
                    toaNumber: "{{ toa_number }}"
                };

                $.ajax({
                    url: `/api/verification/{{ toa_number }}`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(response) {
                        alert('Verification details saved successfully! Email notification has been sent to the employee.');
                    },
                    error: function(error) {
                        console.error('Error saving verification:', error);
                        alert('Failed to save verification details. Please try again.');
                    }
                });
            };
        });
    </script>
</body>
</html>