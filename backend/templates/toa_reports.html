            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>TOA Reports - Travel Authority System</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                <style>
                    body {
                        background-color: #f8f9fa;
                    }
                    .navbar {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    }
                    .card {
                        border-radius: 15px;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                        margin-bottom: 20px;
                    }
                    .card-header {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border-radius: 15px 15px 0 0 !important;
                    }
                    .stat-card {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border-radius: 15px;
                        padding: 20px;
                        margin-bottom: 20px;
                        text-align: center;
                    }
                    .stat-number {
                        font-size: 2.5rem;
                        font-weight: bold;
                        margin-bottom: 5px;
                    }
                    .stat-label {
                        font-size: 0.9rem;
                        opacity: 0.9;
                    }
                    .filter-section {
                        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                        border-radius: 15px;
                        padding: 20px;
                        margin-bottom: 30px;
                    }
                    .table th {
                        background-color: #6c757d;
                        color: white;
                        border: none;
                        cursor: pointer;
                        user-select: none;
                    }
                    .table th:hover {
                        background-color: #5a6268;
                    }
                    .table th.sortable::after {
                        content: ' \f0dc';
                        font-family: 'Font Awesome 6 Free';
                        font-weight: 900;
                        margin-left: 5px;
                        opacity: 0.5;
                    }
                    .table th.sort-asc::after {
                        content: ' \f0de';
                        opacity: 1;
                    }
                    .table th.sort-desc::after {
                        content: ' \f0dd';
                        opacity: 1;
                    }
                    .chart-container {
                        position: relative;
                        height: 300px;
                        margin: 20px 0;
                    }
                    .btn-export {
                        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                        border: none;
                        color: white;
                    }
                    .btn-export:hover {
                        background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
                        color: white;
                    }
                    .status-badge {
                        font-size: 0.8em;
                    }
                </style>
            </head>
            <body>
                <!-- Navigation -->
                <nav class="navbar navbar-expand-lg navbar-dark">
                    <div class="container">
                        <a class="navbar-brand" href="{{ url_for('homepage') }}">
                            <i class="fas fa-plane me-2"></i>Travel Authority System
                        </a>
                        <div class="navbar-nav ms-auto">
                            <a class="nav-link" href="{{ url_for('homepage') }}">
                                <i class="fas fa-home me-1"></i>Home
                            </a>
                            <a class="nav-link" href="{{ url_for('logout') }}">
                                <i class="fas fa-sign-out-alt me-1"></i>Logout
                            </a>
                        </div>
                    </div>
                </nav>

                <!-- Main Content -->
                <div class="container mt-5">
                    <!-- Page Header -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h2><i class="fas fa-chart-bar me-2"></i>TOA Reports & Analytics</h2>
                            <p class="text-muted">Comprehensive reporting and analysis of Travel Order Authority requests</p>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="filter-section">
                        <h5><i class="fas fa-filter me-2"></i>Filters</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <label for="startDate" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="startDate">
                            </div>
                            <div class="col-md-3">
                                <label for="endDate" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="endDate">
                            </div>
                            <div class="col-md-3">
                                <label for="statusFilter" class="form-label">Status</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">All Statuses</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Approved">Approved</option>
                                    <option value="Rejected">Rejected</option>
                                    <option value="Cancelled">Cancelled</option>
                                    <option value="Sent Back">Sent Back</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="divisionFilter" class="form-label">Division</label>
                                <select class="form-select" id="divisionFilter">
                                    <option value="">All Divisions</option>
                                    <option value="Sales & Marketing">Sales & Marketing</option>
                                    <option value="Customer Solutions">Customer Solutions</option>
                                    <option value="Finance, ICT & Admin">Finance, ICT & Admin</option>
                                    <option value="Davao Branch">Davao Branch</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" id="searchInput" 
                                        placeholder="Search by TOA Number, Employee, Department...">
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-primary me-2" onclick="applyFilters()">
                                    <i class="fas fa-search me-1"></i>Apply Filters
                                </button>
                                <button class="btn btn-secondary me-2" onclick="clearFilters()">
                                    <i class="fas fa-times me-1"></i>Clear
                                </button>
                                <button class="btn btn-export" onclick="exportData()">
                                    <i class="fas fa-download me-1"></i>Export CSV
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Statistics -->
                    <div class="row" id="summaryStats">
                        <div class="col-md-2">
                            <div class="stat-card">
                                <div class="stat-number" id="totalTOAs">-</div>
                                <div class="stat-label">Total TOAs</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card">
                                <div class="stat-number" id="approvedTOAs">-</div>
                                <div class="stat-label">Approved</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card">
                                <div class="stat-number" id="cancelledTOAs">-</div>
                                <div class="stat-label">Cancelled</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card">
                                <div class="stat-number" id="withCashAdvance">-</div>
                                <div class="stat-label">With Cash Advance</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card">
                                <div class="stat-number" id="internationalTOAs">-</div>
                                <div class="stat-label">International</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card">
                                <div class="stat-number" id="totalCashAdvance">-</div>
                                <div class="stat-label">Total CA Amount</div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Status Distribution</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="statusChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Division Breakdown</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="divisionChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Monthly Trend (Current Year)</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="monthlyChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Table -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-table me-2"></i>Detailed TOA Records
                                <span class="badge bg-light text-dark ms-2" id="recordCount">0 records</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Loading indicator -->
                            <div id="loading" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading TOA reports...</p>
                            </div>

                            <!-- Table -->
                            <div id="table-container" style="display: none;">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="toaTable">
                                        <thead>
                                            <tr>
                                                <th class="sortable" data-sort="toaNumber">TOA Number</th>
                                                <th class="sortable" data-sort="employee">Employee</th>
                                                <th class="sortable" data-sort="division">Division</th>
                                                <th class="sortable" data-sort="department">Department</th>
                                                <th class="sortable" data-sort="dateFiled">Date Filed</th>
                                                <th class="sortable" data-sort="startDate">Travel Dates</th>
                                                <th class="sortable" data-sort="destinations">Destination</th>
                                                <th class="sortable" data-sort="approvalStatus">Status</th>
                                                <th class="sortable" data-sort="isInternational">Type</th>
                                                 <th>AP/DP Number</th>
                                                <th class="sortable" data-sort="cashAdvanceAmount">CA Amount</th>
                                                <th>Cash Advance Status</th>
                                                <th>Remarks</th>
                                                
                                            </tr>
                                        </thead>
                                        <tbody id="toaTableBody">
                                        </tbody>
                                    </table>
                                </div>

                                <!-- No data message -->
                                <div id="no-data" class="text-center py-4" style="display: none;">
                                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">No TOA records found</h5>
                                    <p class="text-muted">Try adjusting your filter criteria.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Scripts -->
                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
                <script>
                    let allTOAs = [];
                    let filteredTOAs = [];
                    let currentSort = { field: 'dateFiled', direction: 'desc' };
                    let charts = {};

                    // Initialize page
                    document.addEventListener('DOMContentLoaded', function() {
                        // Set default date range (last 30 days)
                        const endDate = new Date();
                        const startDate = new Date();
                        startDate.setDate(endDate.getDate() - 30);
                        
                        document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
                        document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
                        
                        loadData();
                        setupEventListeners();
                        document.getElementById('startDate').addEventListener('change', loadData);
                        document.getElementById('endDate').addEventListener('change', loadData);
                        document.getElementById('statusFilter').addEventListener('change', loadData);
                        document.getElementById('divisionFilter').addEventListener('change', loadData);
                    });

                    function setupEventListeners() {
                        // Sort functionality
                        document.querySelectorAll('.sortable').forEach(th => {
                            th.addEventListener('click', function() {
                                const field = this.dataset.sort;
                                if (currentSort.field === field) {
                                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                                } else {
                                    currentSort.field = field;
                                    currentSort.direction = 'asc';
                                }
                                updateSortHeaders();
                                sortAndDisplayData();
                            });
                        });
                    }

                    async function loadData() {
                        document.getElementById('loading').style.display = 'block';
                        document.getElementById('table-container').style.display = 'none';

                        try {
                            // Build query parameters
                            const params = new URLSearchParams();
                            const startDate = document.getElementById('startDate').value;
                            const endDate = document.getElementById('endDate').value;
                            const status = document.getElementById('statusFilter').value;
                            const division = document.getElementById('divisionFilter').value;
                            
                            if (startDate) params.append('startDate', startDate);
                            if (endDate) params.append('endDate', endDate);
                            if (status) params.append('status', status);
                            if (division) params.append('division', division);

                            // Load summary and detailed data
                            const [summaryResponse, detailedResponse] = await Promise.all([
                                fetch(`/api/toa-reports/summary?${params}`),
                                fetch(`/api/toa-reports/detailed?${params}`)
                            ]);

                            if (!summaryResponse.ok || !detailedResponse.ok) {
                                throw new Error('Failed to load data');
                            }

                            const summaryData = await summaryResponse.json();
                            const detailedData = await detailedResponse.json();

                            // Update UI
                            updateSummaryStats(summaryData.summary);
                            updateCharts(summaryData);
                            allTOAs = detailedData;
                            applyFilters();

                        } catch (error) {
                            console.error('Error loading data:', error);
                            showError('Failed to load TOA reports. Please try again.');
                        } finally {
                            document.getElementById('loading').style.display = 'none';
                            document.getElementById('table-container').style.display = 'block';
                        }
                    }

                    function updateSummaryStats(summary) {
                        document.getElementById('totalTOAs').textContent = summary.total.toLocaleString();
                        document.getElementById('approvedTOAs').textContent = (summary.approved || 0).toLocaleString();
                        document.getElementById('cancelledTOAs').textContent = (summary.cancelled || 0).toLocaleString();
                        document.getElementById('withCashAdvance').textContent = summary.with_cash_advance.toLocaleString();
                        document.getElementById('internationalTOAs').textContent = summary.international.toLocaleString();
                        document.getElementById('totalCashAdvance').textContent = 'PHP ' + summary.total_cash_advance_amount.toLocaleString();
                    }

                    function updateCharts(data) {
                        // Status Chart
                        const statusCtx = document.getElementById('statusChart').getContext('2d');
                        if (charts.status) charts.status.destroy();
                        
                        const statusLabels = Object.keys(data.status_breakdown);
                        const statusData = Object.values(data.status_breakdown);
                        const statusColors = {
                            'Pending': '#ffc107',
                            'Approved': '#28a745',
                            'Rejected': '#dc3545',
                            'Cancelled': '#6c757d',
                            'Sent Back': '#17a2b8'
                        };

                        charts.status = new Chart(statusCtx, {
                            type: 'doughnut',
                            data: {
                                labels: statusLabels,
                                datasets: [{
                                    data: statusData,
                                    backgroundColor: statusLabels.map(label => statusColors[label] || '#6c757d')
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    }
                                }
                            }
                        });

                        // Division Chart
                        const divisionCtx = document.getElementById('divisionChart').getContext('2d');
                        if (charts.division) charts.division.destroy();
                        
                        charts.division = new Chart(divisionCtx, {
                            type: 'bar',
                            data: {
                                labels: data.division_breakdown.map(d => d.division),
                                datasets: [{
                                    label: 'TOAs',
                                    data: data.division_breakdown.map(d => d.count),
                                    backgroundColor: '#667eea'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            precision: 0
                                        }
                                    }
                                }
                            }
                        });

                        // Monthly Chart
                        const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
                        if (charts.monthly) charts.monthly.destroy();
                        
                        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                                        'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        const monthlyData = new Array(12).fill(0);
                        
                        data.monthly_breakdown.forEach(item => {
                            monthlyData[item.month - 1] = item.count;
                        });

                        charts.monthly = new Chart(monthlyCtx, {
                            type: 'line',
                            data: {
                                labels: monthNames,
                                datasets: [{
                                    label: 'TOAs Filed',
                                    data: monthlyData,
                                    borderColor: '#667eea',
                                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            precision: 0
                                        }
                                    }
                                }
                            }
                        });
                    }

                    function applyFilters() {
                        const search = document.getElementById('searchInput').value.toLowerCase();
                        
                        filteredTOAs = allTOAs.filter(toa => {
                            if (search) {
                                const searchableText = [
                                    toa.toaNumber,
                                    toa.employee,
                                    toa.department,
                                    toa.division,
                                    toa.destinations.join(' '),
                                    toa.purpose
                                ].join(' ').toLowerCase();
                                
                                if (!searchableText.includes(search)) {
                                    return false;
                                }
                            }
                            return true;
                        });

                        sortAndDisplayData();
                    }

                    function sortAndDisplayData() {
                        // Sort data
                        filteredTOAs.sort((a, b) => {
                            let aVal = a[currentSort.field];
                            let bVal = b[currentSort.field];

                            // Handle special cases
                            if (currentSort.field === 'destinations') {
                                aVal = aVal.join(', ');
                                bVal = bVal.join(', ');
                            } else if (currentSort.field === 'dateFiled' || currentSort.field === 'startDate') {
                                aVal = new Date(aVal);
                                bVal = new Date(bVal);
                            } else if (typeof aVal === 'string') {
                                aVal = aVal.toLowerCase();
                                bVal = bVal.toLowerCase();
                            }

                            if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                            if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                            return 0;
                        });

                        // Display data
                        displayTable();
                        updateRecordCount();
                    }

                    function displayTable() {
                        const tbody = document.getElementById('toaTableBody');
                        tbody.innerHTML = '';

                        if (filteredTOAs.length === 0) {
                            document.getElementById('no-data').style.display = 'block';
                            return;
                        }

                        document.getElementById('no-data').style.display = 'none';

                        filteredTOAs.forEach(toa => {
                            const row = createTableRow(toa);
                            tbody.appendChild(row);
                        });
                    }

                    function createTableRow(toa) {
                        const row = document.createElement('tr');
                        
                        // Format dates
                        const dateFiled = new Date(toa.dateFiled).toLocaleDateString();
                        const startDate = new Date(toa.startDate).toLocaleDateString();
                        const endDate = new Date(toa.endDate).toLocaleDateString();
                        
                        // Status badge
                        const statusClass = getStatusClass(toa.approvalStatus);
                        const typeClass = toa.isInternational ? 'badge bg-info' : 'badge bg-secondary';
                        
                        let caStatusText = '';
                        if (toa.hasCashAdvance) {
                            if (toa.released === true) {
                                caStatusText = '<span class="badge bg-success">Released</span>';
                            } else {
                                caStatusText = '<span class="badge bg-warning text-dark">Not Yet Released</span>';
                            }
                        } else {
                            caStatusText = '<span class="badge bg-secondary">No Cash Advance</span>';
                        }

                        let remarksArr = [];
                        if (Array.isArray(toa.approvers)) {
                            toa.approvers.forEach(a => {
                                if (a.status === 'Rejected' && a.remarks) {
                                    remarksArr.push(` ${a.remarks}`);
                                }
                            });
                        }
                        
                        if (remarksArr.length === 0) {
                            if (['Rejected', 'Cancelled', 'Sent Back'].includes(toa.approvalStatus)) {
                                remarksArr.push(toa.remarks || toa.cancellationReason || toa.sentBackRemarks || 'No remarks');
                            } else if (toa.cashAdvanceStatus === 'Rejected' && toa.cashAdvanceRemarks) {
                                remarksArr.push(toa.cashAdvanceRemarks);
                            }
                        }
                        const remarks = remarksArr.join('<br>');
                        console.log('TOA:', toa.toaNumber, 'Remarks:', remarksArr);

                        const cleanDestinations = toa.destinations
                            .filter(dest => dest && dest.trim())
                            .join(', ');

                        row.innerHTML = `
                            <td><strong>${toa.toaNumber}</strong></td>
                            <td>${toa.employee}</td>
                            <td>${toa.division}</td>
                            <td>${toa.department}</td>
                            <td>${dateFiled}</td>
                            <td>${startDate} - ${endDate}</td>
                            <td>${cleanDestinations}</td>
                            <td><span class="badge ${statusClass}">${toa.approvalStatus}</span></td>
                            <td><span class="${typeClass}">${toa.isInternational ? 'International' : 'Domestic'}</span></td>
                            <td>${toa.apdpNumber || ''}
                            <td>PHP ${toa.cashAdvanceAmount.toLocaleString()}</td>
                            <td>${caStatusText}</td>
                            <td>${remarks}</td>
                        `;

                        return row;
                    }

                    function getStatusClass(status) {
                        switch(status) {
                            case 'Approved': return 'bg-success';
                            case 'Rejected': return 'bg-danger';
                            case 'Pending': case 'Pending Approval': return 'bg-warning text-dark';
                            case 'Sent Back': return 'bg-info';
                            case 'Cancelled': return 'bg-dark';
                            default: return 'bg-secondary';
                        }
                    }

                    function updateSortHeaders() {
                        document.querySelectorAll('.sortable').forEach(th => {
                            th.classList.remove('sort-asc', 'sort-desc');
                            if (th.dataset.sort === currentSort.field) {
                                th.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                            }
                        });
                    }

                    function updateRecordCount() {
                        const count = filteredTOAs.length;
                        const total = allTOAs.length;
                        const countElement = document.getElementById('recordCount');
                        
                        if (count === total) {
                            countElement.textContent = `${count} record${count !== 1 ? 's' : ''}`;
                        } else {
                            countElement.textContent = `${count} of ${total} record${total !== 1 ? 's' : ''}`;
                        }
                    }

                    function clearFilters() {
                        document.getElementById('startDate').value = '';
                        document.getElementById('endDate').value = '';
                        document.getElementById('statusFilter').value = '';
                        document.getElementById('divisionFilter').value = '';
                        document.getElementById('searchInput').value = '';
                        loadData();
                    }

                    function exportData() {
                        const params = new URLSearchParams();
                        const startDate = document.getElementById('startDate').value;
                        const endDate = document.getElementById('endDate').value;
                        const status = document.getElementById('statusFilter').value;
                        const division = document.getElementById('divisionFilter').value;
                        
                        if (startDate) params.append('startDate', startDate);
                        if (endDate) params.append('endDate', endDate);
                        if (status) params.append('status', status);
                        if (division) params.append('division', division);

                        window.open(`/api/toa-reports/export?${params}`, '_blank');
                    }

                    function showError(message) {
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                        alertDiv.innerHTML = `
                            ${message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        
                        const container = document.querySelector('.container');
                        container.insertBefore(alertDiv, container.firstChild);
                    }

                    // Initialize sort headers
                    updateSortHeaders();
                </script>
            </body>
            </html>